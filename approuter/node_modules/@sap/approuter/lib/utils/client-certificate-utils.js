'use strict';
const { toPem } = require('jks-js');

const KeySeparator = pem => {
  const separator = pem.match(/([-]+END [^\\s]+ PRIVATE KEY[-]+)|([-]+END PRIVATE KEY[-]+)/);
  return separator ? separator[0] : undefined;
};

const parseTextFormat = content => {
  const pem = Buffer.from(content,'base64').toString('ascii'); //  TODO  forge
  const separator = KeySeparator(pem);
  if (separator){
    const separated = pem.split(separator);
    const cert = separated[1];
    const key = separated[0] + separator;
    return  { cert, key };
  }
};

const parseBinaryFormat = (content, password) => {
  try {
    const buffer = Buffer.from(content,'base64');
    const pem = toPem(buffer, password);
    const { cert ,key }  = Object.values(pem)[0];
    return { cert, key };
  }
  catch (e) {
    // log error
    return undefined;
  }
};

const  parseCertificate = (certificateObj, password) => {
  const {  Content , Name } = certificateObj;
  const  fileExtension =  Name.split('.').pop();
  if (fileExtension !== 'pem') {
    return  parseBinaryFormat(Content,password);
  }
  return parseTextFormat(Content);
};

const getClientCertificates =  destinationLookUpResult  => {
  if (!destinationLookUpResult.certificates){
    return null;
  }
  const { KeyStoreLocation, TrustStoreLocation, TrustStorePassword, KeyStorePassword } = destinationLookUpResult.destinationConfiguration ;
  const { certificates } =  destinationLookUpResult ;
  const clientCertificates = {};

  certificates.forEach((certificate) => {
    let certificateType;
    if (certificate['Name'] === KeyStoreLocation){
      certificateType = 'clientCertifacate';
    }
    else if (certificate['Name'] === TrustStoreLocation){
      certificateType = 'trustCertifacate';
    }

    if (certificateType){
      const password = certificateType === 'clientCertifacate' ? KeyStorePassword : TrustStorePassword ;
      clientCertificates[certificateType] = parseCertificate(certificate,password);
    }
  });
  return clientCertificates ;
};


const escape = (destination,req) => {
  return ;          // todo escape logic
};

module.exports =  {
  getClientCertificates,
  escape
};
